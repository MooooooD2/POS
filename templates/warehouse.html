<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø®Ø²Ù† - Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</title>
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 28px;
        }
        
        .btn {
            padding: 10px 20px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: #27ae60;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-info {
            background: #3498db;
            color: white;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 20px;
        }
        
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .main-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, #f39c12 0%, #d35400 100%);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .products-table th,
        .products-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        
        .products-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        
        .products-table tr:hover {
            background: #f5f5f5;
        }
        
        .low-stock {
            color: #e74c3c;
            font-weight: bold;
            background-color: #ffebee;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .barcode-scanner {
            text-align: center;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .barcode-input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            text-align: center;
            border: 3px solid #667eea;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .print-btn {
            background: #9b59b6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
        #barcodeScannerModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        #barcodeScannerContainer {
            width: 90%;
            max-width: 640px;
            position: relative;
        }
        
        #barcodeScannerVideo {
            width: 100%;
            border: 3px solid #667eea;
            border-radius: 10px;
            background: black;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid rgba(102, 126, 234, 0.8);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }
        
        .scanner-line {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(102, 126, 234, 0.8);
            animation: scan 2s infinite linear;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .scanner-controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }
        
        .scanner-btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .scanner-btn-close {
            background: #e74c3c;
            color: white;
        }
        
        .scanner-btn-close:hover {
            background: #c0392b;
        }
        
        .scanner-status {
            color: white;
            font-size: 16px;
            margin-top: 15px;
            text-align: center;
        }
        
        @media print {
            .btn, header, .sidebar, .no-print {
                display: none !important;
            }
            
            .main-content {
                box-shadow: none !important;
                padding: 0 !important;
            }
            
            body {
                background: white !important;
                padding: 0 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“¦ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø®Ø²Ù†</h1>
            <div>
                <button class="btn" onclick="location.href='/'">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙƒØ§Ø´ÙŠØ±</button>
                <button class="btn btn-primary" onclick="openAddProductModal()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
                <button class="btn" onclick="openBarcodeScanner()">ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
                <button class="btn print-btn" onclick="printStockReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            </div>
        </header>
        
        <div class="content">
            <div class="sidebar">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
                        <div class="stat-value" id="totalProducts">0</div>
                    </div>
                    
                    <div class="stat-card warning">
                        <div class="stat-label">Ù…Ù†Ø®ÙØ¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
                        <div class="stat-value" id="lowStock">0</div>
                    </div>
                    
                    <div class="stat-card danger">
                        <div class="stat-label">Ù†ÙØ° Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
                        <div class="stat-value" id="outOfStock">0</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</div>
                        <div class="stat-value" id="totalQuantity">0</div>
                    </div>
                </div>
                
                <h3 style="margin: 20px 0 10px 0;">Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h3>
                <div id="categoriesList"></div>
            </div>
            
            <div class="main-content">
                <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
                
                <!-- Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ -->
                <div class="barcode-scanner">
                    <h3>ğŸ“± Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h3>
                    <input type="text" class="barcode-input" id="barcodeScanner" 
                           placeholder="Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹..." 
                           onkeypress="handleBarcodeScan(event)">
                    <p style="color: #666; font-size: 12px;">
                        ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ø¶ØºØ· Ø²Ø± "ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯" Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹
                    </p>
                </div>
                
                <div id="message"></div>
                <table class="products-table" id="productsTable">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ø³Ø¹Ø±</th>
                            <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</th>
                            <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                            <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="productsBody">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px;">
                                Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Ù†Ø§ÙØ°Ø© Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
    <div id="barcodeScannerModal">
        <div id="barcodeScannerContainer">
            <video id="barcodeScannerVideo" playsinline></video>
            <div class="scanner-overlay">
                <div class="scanner-line"></div>
            </div>
        </div>
        <div class="scanner-status" id="scannerStatus">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</div>
        <div class="scanner-controls">
            <button class="scanner-btn scanner-btn-close" onclick="closeBarcodeScanner()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
    
    <!-- Modal Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h2>
                <button class="close-modal" onclick="closeModal('productModal')">&times;</button>
            </div>
            <div id="modalMessage"></div>
            <form id="productForm">
                <input type="hidden" id="productId">
                
                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ *</label>
                    <input type="text" id="productBarcode" required>
                </div>
                
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ *</label>
                    <input type="text" id="productName" required>
                </div>
                
                <div class="form-group">
                    <label>Ø§Ù„Ø³Ø¹Ø± (Ù„Ù„Ø¨ÙŠØ¹) *</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label>
                    <input type="number" id="productCostPrice" step="0.01" value="0">
                </div>
                
                <div class="form-group">
                    <label>Ø§Ù„ÙƒÙ…ÙŠØ© *</label>
                    <input type="number" id="productQuantity" required min="0">
                </div>
                
                <div class="form-group">
                    <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</label>
                    <input type="number" id="productMinStock" value="5" min="0">
                </div>
                
                <div class="form-group">
                    <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                    <select id="productCategory">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</option>
                        <option value="Ø£ØºØ°ÙŠØ©">Ø£ØºØ°ÙŠØ©</option>
                        <option value="Ù…Ù†Ø¸ÙØ§Øª">Ù…Ù†Ø¸ÙØ§Øª</option>
                        <option value="Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª">Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª</option>
                        <option value="Ù…Ø´Ø±ÙˆØ¨Ø§Øª">Ù…Ø´Ø±ÙˆØ¨Ø§Øª</option>
                        <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                    <input type="text" id="productSupplier">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 16px;">
                    Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬
                </button>
            </form>
        </div>
    </div>
    
    <!-- ØµÙØ­Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
    <div id="printArea" style="display: none;">
        <div style="text-align: center; padding: 20px;">
            <h1>ğŸ“¦ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²Ù†</h1>
            <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <span id="printDate"></span></p>
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: <span id="printTotalProducts"></span></p>
            <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©: <span id="printTotalQuantity"></span></p>
        </div>
        
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
                <tr>
                    <th style="border: 1px solid #000; padding: 10px;">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
                    <th style="border: 1px solid #000; padding: 10px;">Ø§Ù„Ø§Ø³Ù…</th>
                    <th style="border: 1px solid #000; padding: 10px;">Ø§Ù„Ø³Ø¹Ø±</th>
                    <th style="border: 1px solid #000; padding: 10px;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th style="border: 1px solid #000; padding: 10px;">Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                </tr>
            </thead>
            <tbody id="printTableBody">
            </tbody>
        </table>
    </div>
    
    <script>
        let products = [];
        let editingProductId = null;
        let barcodeScannerActive = false;
        let scannerStream = null;
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        window.onload = function() {
            loadProducts();
            document.getElementById('printDate').textContent = new Date().toLocaleDateString('ar-EG');
        };
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        function loadProducts() {
            fetch('/api/products')
                .then(response => response.json())
                .then(data => {
                    products = data.products;
                    displayProducts();
                    updateStats();
                });
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        function displayProducts() {
            const tbody = document.getElementById('productsBody');
            tbody.innerHTML = '';
            
            if (products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px;">
                            Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª
                        </td>
                    </tr>
                `;
                return;
            }
            
            products.forEach(product => {
                const row = document.createElement('tr');
                row.className = product.low_stock ? 'low-stock' : '';
                row.innerHTML = `
                    <td>${product.barcode || '-'}</td>
                    <td><strong>${product.name}</strong></td>
                    <td>${product.price.toFixed(2)} Ø¬Ù†ÙŠÙ‡</td>
                    <td>${product.cost_price.toFixed(2)} Ø¬Ù†ÙŠÙ‡</td>
                    <td>${product.quantity}</td>
                    <td>${product.min_stock}</td>
                    <td>${product.category || '-'}</td>
                    <td>${product.supplier || '-'}</td>
                    <td>
                        <button class="btn btn-warning" onclick="addStock(${product.id})" title="Ø¥Ø¶Ø§ÙØ© ÙƒÙ…ÙŠØ©">
                            + ÙƒÙ…ÙŠØ©
                        </button>
                        <button class="btn btn-info" onclick="editProduct(${product.id})" title="ØªØ¹Ø¯ÙŠÙ„">
                            âœï¸ ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button class="btn btn-danger" onclick="deleteProduct(${product.id})" title="Ø­Ø°Ù">
                            ğŸ—‘ï¸ Ø­Ø°Ù
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function updateStats() {
            const lowStock = products.filter(p => p.quantity <= p.min_stock && p.quantity > 0).length;
            const outOfStock = products.filter(p => p.quantity === 0).length;
            
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('lowStock').textContent = lowStock;
            document.getElementById('outOfStock').textContent = outOfStock;
            document.getElementById('totalQuantity').textContent = 
                products.reduce((sum, p) => sum + p.quantity, 0);
        }
        
        // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬
        function openAddProductModal(barcode = '') {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productBarcode').value = barcode;
            document.getElementById('modalMessage').innerHTML = '';
            document.getElementById('productModal').style.display = 'flex';
            
            // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù…
            setTimeout(() => {
                document.getElementById('productName').focus();
            }, 100);
        }
        
        // ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            editingProductId = productId;
            document.getElementById('modalTitle').textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬';
            document.getElementById('productId').value = product.id;
            document.getElementById('productBarcode').value = product.barcode || '';
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productCostPrice').value = product.cost_price;
            document.getElementById('productQuantity').value = product.quantity;
            document.getElementById('productMinStock').value = product.min_stock;
            document.getElementById('productCategory').value = product.category || '';
            document.getElementById('productSupplier').value = product.supplier || '';
            
            document.getElementById('productModal').style.display = 'flex';
            
            // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
            setTimeout(() => {
                document.getElementById('productName').focus();
            }, 100);
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            editingProductId = null;
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ (Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„)
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productData = {
                barcode: document.getElementById('productBarcode').value,
                name: document.getElementById('productName').value,
                price: document.getElementById('productPrice').value,
                cost_price: document.getElementById('productCostPrice').value,
                quantity: document.getElementById('productQuantity').value,
                min_stock: document.getElementById('productMinStock').value,
                category: document.getElementById('productCategory').value,
                supplier: document.getElementById('productSupplier').value
            };
            
            const messageDiv = document.getElementById('modalMessage');
            
            if (editingProductId) {
                // ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯
                fetch(`/api/products/${editingProductId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        messageDiv.className = 'message success';
                        messageDiv.textContent = data.message;
                        setTimeout(() => {
                            closeModal('productModal');
                            loadProducts();
                        }, 1500);
                    } else {
                        messageDiv.className = 'message error';
                        messageDiv.textContent = data.message;
                    }
                });
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
                fetch('/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        messageDiv.className = 'message success';
                        messageDiv.textContent = data.message;
                        setTimeout(() => {
                            closeModal('productModal');
                            loadProducts();
                        }, 1500);
                    } else {
                        messageDiv.className = 'message error';
                        messageDiv.textContent = data.message;
                    }
                });
            }
        });
        
        // Ø¥Ø¶Ø§ÙØ© ÙƒÙ…ÙŠØ© Ù„Ù…Ù†ØªØ¬
        function addStock(productId) {
            const quantity = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§:');
            const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):', 'Ø¥Ø¶Ø§ÙØ© Ù…Ø®Ø²ÙˆÙ†');
            
            if (quantity && parseInt(quantity) > 0) {
                fetch(`/api/products/${productId}/add_stock`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        quantity: parseInt(quantity),
                        reason: reason || 'Ø¥Ø¶Ø§ÙØ© Ù…Ø®Ø²ÙˆÙ†'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    const messageDiv = document.getElementById('message');
                    if (data.success) {
                        messageDiv.className = 'message success';
                        messageDiv.textContent = data.message;
                        setTimeout(() => {
                            messageDiv.className = '';
                            messageDiv.textContent = '';
                        }, 3000);
                        loadProducts();
                    }
                });
            }
        }
        
        // Ø­Ø°Ù Ù…Ù†ØªØ¬
        function deleteProduct(productId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) {
                fetch(`/api/products/${productId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadProducts();
                    }
                });
            }
        }
        
        // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹
        function handleBarcodeScan(event) {
            if (event.key === 'Enter') {
                const barcode = document.getElementById('barcodeScanner').value.trim();
                
                if (barcode) {
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
                    const existingProduct = products.find(p => p.barcode === barcode);
                    
                    if (existingProduct) {
                        // Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„Ù‡
                        editProduct(existingProduct.id);
                    } else {
                        // Ø¥Ø°Ø§ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
                        openAddProductModal(barcode);
                    }
                    
                    // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
                    document.getElementById('barcodeScanner').value = '';
                }
            }
        }
        
        // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        function openBarcodeScanner() {
            document.getElementById('barcodeScannerModal').style.display = 'flex';
            document.getElementById('scannerStatus').textContent = 'Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';
            
            // Ø·Ù„Ø¨ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment" // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ù„Ø¬ÙˆØ§Ù„
                } 
            })
            .then(stream => {
                scannerStream = stream;
                const video = document.getElementById('barcodeScannerVideo');
                video.srcObject = stream;
                video.play();
                
                document.getElementById('scannerStatus').textContent = ' ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯...';
                
                // Ø¨Ø¯Ø¡ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
                barcodeScannerActive = true;
                startBarcodeScanner();
            })
            .catch(err => {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', err);
                document.getElementById('scannerStatus').textContent = 'Ø®Ø·Ø£: ' + err.message;
                setTimeout(closeBarcodeScanner, 3000);
            });
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        function closeBarcodeScanner() {
            barcodeScannerActive = false;
            
            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            if (scannerStream) {
                scannerStream.getTracks().forEach(track => track.stop());
                scannerStream = null;
            }
            
            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            const video = document.getElementById('barcodeScannerVideo');
            video.srcObject = null;
            
            document.getElementById('barcodeScannerModal').style.display = 'none';
        }
        
        // Ø¨Ø¯Ø¡ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        function startBarcodeScanner() {
            if (!barcodeScannerActive) return;
            
            const video = document.getElementById('barcodeScannerVideo');
            
            // Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… QuaggaJS Ù„Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
            Quagga.decodeSingle({
                decoder: {
                    readers: ["ean_13_reader", "ean_8_reader", "upc_reader", "code_128_reader"]
                },
                locate: true,
                src: canvas.toDataURL('image/png')
            }, function(result) {
                if (result && result.codeResult) {
                    const barcode = result.codeResult.code;
                    document.getElementById('scannerStatus').textContent = 'ØªÙ… Ø§ÙƒØªØ´Ø§Ù: ' + barcode;
                    
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
                    searchProductByBarcode(barcode);
                    
                    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
                    setTimeout(closeBarcodeScanner, 1000);
                } else {
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                    setTimeout(startBarcodeScanner, 500);
                }
            });
        }
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        function searchProductByBarcode(barcode) {
            const existingProduct = products.find(p => p.barcode === barcode);
            
            if (existingProduct) {
                // Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„Ù‡
                editProduct(existingProduct.id);
            } else {
                // Ø¥Ø°Ø§ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
                openAddProductModal(barcode);
            }
        }
        
        // Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        function printStockReport() {
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            document.getElementById('printTotalProducts').textContent = products.length;
            document.getElementById('printTotalQuantity').textContent = 
                products.reduce((sum, p) => sum + p.quantity, 0);
            
            // Ù…Ù„Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            const printBody = document.getElementById('printTableBody');
            printBody.innerHTML = '';
            
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="border: 1px solid #000; padding: 8px;">${product.barcode || '-'}</td>
                    <td style="border: 1px solid #000; padding: 8px;">${product.name}</td>
                    <td style="border: 1px solid #000; padding: 8px;">${product.price.toFixed(2)}</td>
                    <td style="border: 1px solid #000; padding: 8px;">${product.quantity}</td>
                    <td style="border: 1px solid #000; padding: 8px;">${product.category || '-'}</td>
                `;
                printBody.appendChild(row);
            });
            
            // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø©
            window.print();
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
        window.onclick = function(event) {
            const modal = document.getElementById('productModal');
            const scannerModal = document.getElementById('barcodeScannerModal');
            
            if (event.target === modal) {
                closeModal('productModal');
            }
            
            if (event.target === scannerModal) {
                closeBarcodeScanner();
            }
        };
    </script>
</body>
</html>